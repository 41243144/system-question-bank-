{% extends "base.html" %}

{% block title %}åŒ¯å…¥é¡Œç›® - ä½œæ¥­ç³»çµ±é¡Œåº«{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>ğŸ“¥ åŒ¯å…¥é¡Œç›®</h1>
    <div>
        <a href="{{ url_for('import_help') }}" class="btn btn-info">â“ ä½¿ç”¨èªªæ˜</a>
        <a href="{{ url_for('index') }}" class="btn btn-secondary">â† è¿”å›é¦–é </a>
    </div>
</div>

<!-- Flash è¨Šæ¯ -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}

<div class="row">
    <div class="col-md-8 mx-auto">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">ğŸ“¤ ä¸Šå‚³é¡Œç›®æª”æ¡ˆ</h5>
            </div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data" id="importForm">
                    <!-- åŒ¯å…¥æ–¹å¼é¸æ“‡ -->
                    <div class="mb-3">
                        <label class="form-label">åŒ¯å…¥æ–¹å¼ï¼š<span class="text-danger">*</span></label>
                        <div class="btn-group w-100" role="group" aria-label="åŒ¯å…¥æ–¹å¼é¸æ“‡">
                            <input type="radio" class="btn-check" name="import_method" id="method_file" value="file" checked>
                            <label class="btn btn-outline-primary" for="method_file">ğŸ“ ä¸Šå‚³æª”æ¡ˆ</label>
                            
                            <input type="radio" class="btn-check" name="import_method" id="method_text" value="text">
                            <label class="btn btn-outline-success" for="method_text">ğŸ“ è²¼å…¥æ–‡å­—</label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="chapter" class="form-label">ç« ç¯€é¸æ“‡ï¼š<span class="text-danger">*</span></label>
                        <div class="row">
                            <div class="col-md-6">
                                <select class="form-select" id="chapter" name="chapter" required>
                                    <option value="">è«‹é¸æ“‡ç« ç¯€</option>
                                    <option value="ch1">CH1 - ç¬¬ä¸€ç« </option>
                                    <option value="ch2">CH2 - ç¬¬äºŒç« </option>
                                    <option value="ch3">CH3 - ç¬¬ä¸‰ç« </option>
                                    <option value="ch4">CH4 - ç¬¬å››ç« </option>
                                    <option value="ch5">CH5 - ç¬¬äº”ç« </option>
                                    <option value="ch6">CH6 - ç¬¬å…­ç« </option>
                                    <option value="ch7">CH7 - ç¬¬ä¸ƒç« </option>
                                    <option value="ch8">CH8 - ç¬¬å…«ç« </option>
                                    <option value="ch9">CH9 - ç¬¬ä¹ç« </option>
                                    <option value="ch10">CH10 - ç¬¬åç« </option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <input type="text" class="form-control" id="custom_chapter" placeholder="æˆ–è¼¸å…¥è‡ªè¨‚ç« ç¯€ (å¦‚: ch11)">
                                <div class="form-text">æ ¼å¼ï¼šch + æ•¸å­— (å¦‚ï¼šch1, ch2)</div>
                            </div>
                        </div>
                    </div>

                    <!-- æª”æ¡ˆä¸Šå‚³å€åŸŸ -->
                    <div class="mb-3" id="file-upload-section">
                        <label for="file" class="form-label">é¸æ“‡æª”æ¡ˆï¼š<span class="text-danger">*</span></label>
                        <input type="file" class="form-control" id="file" name="file" accept=".txt">
                        <div class="form-text">æ”¯æ´ .txt æª”æ¡ˆï¼Œç·¨ç¢¼æ ¼å¼ï¼šUTF-8</div>
                    </div>

                    <!-- æ–‡å­—è¼¸å…¥å€åŸŸ -->
                    <div class="mb-3" id="text-input-section" style="display: none;">
                        <label for="text_content" class="form-label">è²¼å…¥é¡Œç›®å…§å®¹ï¼š<span class="text-danger">*</span></label>
                        <textarea class="form-control" id="text_content" name="text_content" rows="15" 
                                  placeholder="è«‹è²¼å…¥é¡Œç›®å…§å®¹ï¼Œæ ¼å¼ç¯„ä¾‹ï¼š

é¡Œç›®ï¼šä½œæ¥­ç³»çµ±çš„ä¸»è¦åŠŸèƒ½ä¸åŒ…æ‹¬ä»¥ä¸‹å“ªä¸€é …ï¼Ÿ
ä½ çš„ç­”æ¡ˆï¼š
(A) è™•ç†å™¨ç®¡ç†
æ­£ç¢ºç­”æ¡ˆï¼š
(D) ç¡¬é«”è¨­è¨ˆ
å¾—åˆ†ï¼š10

é¡Œç›®ï¼šä¸‹åˆ—ä½•è€…æ˜¯ä½œæ¥­ç³»çµ±çš„æ ¸å¿ƒçµ„ä»¶ï¼Ÿ
ä½ çš„ç­”æ¡ˆï¼š
æœªä½œç­”
æ­£ç¢ºç­”æ¡ˆï¼š
æ ¸å¿ƒ (Kernel)
å¾—åˆ†ï¼š0"></textarea>
                        <div class="form-text">ç›´æ¥è²¼å…¥é¡Œç›®æ–‡å­—å…§å®¹ï¼Œæ”¯æ´æ¨™æº–é¡Œç›®æ ¼å¼</div>
                    </div>

                    <!-- æª”æ¡ˆé è¦½å€åŸŸ -->
                    <div id="preview-section" class="mb-3" style="display: none;">
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">ğŸ“‹ æª”æ¡ˆé è¦½</h6>
                            </div>
                            <div class="card-body" id="preview-content">
                                <!-- é è¦½å…§å®¹å°‡å‹•æ…‹è¼‰å…¥ -->
                            </div>
                        </div>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-outline-info" id="previewBtn">
                            ğŸ‘€ é è¦½å…§å®¹
                        </button>
                        <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                            ğŸ“¥ é–‹å§‹åŒ¯å…¥
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- åŒ¯å…¥é ˆçŸ¥ -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">âš ï¸ åŒ¯å…¥é ˆçŸ¥</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <h6>ï¿½ æª”æ¡ˆä¸Šå‚³è¦æ±‚ï¼š</h6>
                        <ul>
                            <li>æª”æ¡ˆé¡å‹ï¼š.txt</li>
                            <li>ç·¨ç¢¼æ ¼å¼ï¼šUTF-8</li>
                            <li>å…§å®¹æ ¼å¼ï¼šæ¨™æº–é¡Œç›®æ ¼å¼</li>
                        </ul>
                    </div>
                    <div class="col-md-4">
                        <h6>ğŸ“ æ–‡å­—è²¼å…¥è¦æ±‚ï¼š</h6>
                        <ul>
                            <li>ç›´æ¥è¤‡è£½è²¼ä¸Šæ–‡å­—å…§å®¹</li>
                            <li>æ”¯æ´æ¨™æº–é¡Œç›®æ ¼å¼</li>
                            <li>å³æ™‚é è¦½è§£æçµæœ</li>
                        </ul>
                    </div>
                    <div class="col-md-4">
                        <h6>ï¿½ æ¨™æº–æ ¼å¼ç¯„ä¾‹ï¼š</h6>
                        <pre class="bg-light p-2 rounded small"><code>é¡Œç›®ï¼šé€™æ˜¯ä¸€å€‹ç¯„ä¾‹é¡Œç›®ï¼Ÿ
ä½ çš„ç­”æ¡ˆï¼š
é¸é …A
æ­£ç¢ºç­”æ¡ˆï¼š
æ­£ç¢ºé¸é …A
å¾—åˆ†ï¼š10</code></pre>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-12">
                        <h6>ğŸ”„ åŒ¯å…¥è¦å‰‡ï¼š</h6>
                        <ul>
                            <li>é‡è¤‡çš„é¡Œç›®å°‡è¢«è‡ªå‹•è·³é</li>
                            <li>æ²’æœ‰æ­£ç¢ºç­”æ¡ˆæˆ–æ¨™è¨˜ç‚º"æœªä½œç­”"çš„é¡Œç›®å°‡è¢«è·³é</li>
                            <li>ç³»çµ±æœƒè‡ªå‹•åµæ¸¬é¡Œç›®é¡å‹ï¼ˆé¸æ“‡é¡Œ/å¡«ç©ºé¡Œï¼‰</li>
                            <li>åŒ¯å…¥å¾Œå¯ä»¥åœ¨å°æ‡‰ç« ç¯€æŸ¥çœ‹çµæœ</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æœ€è¿‘åŒ¯å…¥è¨˜éŒ„ -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">ğŸ“Š ç›®å‰é¡Œåº«ç‹€æ…‹</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <h3 class="text-primary">{{ stats.total_questions }}</h3>
                        <p class="text-muted">ç¸½é¡Œæ•¸</p>
                    </div>
                    <div class="col-md-3">
                        <h3 class="text-success">{{ stats.chapter_stats|length }}</h3>
                        <p class="text-muted">ç« ç¯€æ•¸</p>
                    </div>
                    <div class="col-md-3">
                        <h3 class="text-info">{{ stats.type_stats.get('é¸æ“‡é¡Œ', 0) }}</h3>
                        <p class="text-muted">é¸æ“‡é¡Œ</p>
                    </div>
                    <div class="col-md-3">
                        <h3 class="text-warning">{{ stats.type_stats.get('å¡«ç©ºé¡Œ', 0) }}</h3>
                        <p class="text-muted">å¡«ç©ºé¡Œ</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const chapterSelect = document.getElementById('chapter');
    const customChapterInput = document.getElementById('custom_chapter');
    const fileInput = document.getElementById('file');
    const textContent = document.getElementById('text_content');
    const previewBtn = document.getElementById('previewBtn');
    const previewSection = document.getElementById('preview-section');
    const previewContent = document.getElementById('preview-content');
    const importForm = document.getElementById('importForm');
    const methodFile = document.getElementById('method_file');
    const methodText = document.getElementById('method_text');
    const fileUploadSection = document.getElementById('file-upload-section');
    const textInputSection = document.getElementById('text-input-section');

    // åŒ¯å…¥æ–¹å¼åˆ‡æ›
    function toggleImportMethod() {
        if (methodText.checked) {
            fileUploadSection.style.display = 'none';
            textInputSection.style.display = 'block';
            fileInput.required = false;
            textContent.required = true;
        } else {
            fileUploadSection.style.display = 'block';
            textInputSection.style.display = 'none';
            fileInput.required = true;
            textContent.required = false;
        }
    }

    methodFile.addEventListener('change', toggleImportMethod);
    methodText.addEventListener('change', toggleImportMethod);
    toggleImportMethod(); // åˆå§‹åŒ–

    // è‡ªè¨‚ç« ç¯€è¼¸å…¥
    customChapterInput.addEventListener('input', function() {
        if (this.value.trim()) {
            chapterSelect.value = '';
            // æ›´æ–°è¡¨å–®çš„ chapter å€¼
            chapterSelect.name = '';
            this.name = 'chapter';
        } else {
            chapterSelect.name = 'chapter';
            this.name = '';
        }
    });

    chapterSelect.addEventListener('change', function() {
        if (this.value) {
            customChapterInput.value = '';
            customChapterInput.name = '';
            this.name = 'chapter';
        }
    });

    // é è¦½åŠŸèƒ½
    previewBtn.addEventListener('click', function() {
        const chapter = chapterSelect.value || customChapterInput.value.trim();
        const isTextMode = methodText.checked;

        if (!chapter) {
            alert('è«‹é¸æ“‡æˆ–è¼¸å…¥ç« ç¯€');
            return;
        }

        let hasContent = false;
        const formData = new FormData();
        
        if (isTextMode) {
            const text = textContent.value.trim();
            if (!text) {
                alert('è«‹è²¼å…¥é¡Œç›®å…§å®¹');
                return;
            }
            formData.append('import_method', 'text');
            formData.append('text_content', text);
            hasContent = true;
        } else {
            const file = fileInput.files[0];
            if (!file) {
                alert('è«‹å…ˆé¸æ“‡æª”æ¡ˆ');
                return;
            }
            formData.append('import_method', 'file');
            formData.append('file', file);
            hasContent = true;
        }

        if (!hasContent) return;

        // é¡¯ç¤ºè¼‰å…¥ä¸­
        previewContent.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"></div><p>è§£æä¸­...</p></div>';
        previewSection.style.display = 'block';

        fetch('/api/import/preview', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                previewContent.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                return;
            }

            let html = `<h6>ç¸½å…±æ‰¾åˆ° ${data.total_questions} é“é¡Œç›®</h6>`;
            html += `<p class="text-muted">åŒ¯å…¥æ–¹å¼ï¼š${data.method === 'text' ? 'ğŸ“ æ–‡å­—è²¼å…¥' : 'ğŸ“ æª”æ¡ˆä¸Šå‚³'}</p>`;
            
            if (data.preview && data.preview.length > 0) {
                html += '<h6>å‰ 5 é¡Œé è¦½ï¼š</h6>';
                data.preview.forEach((item, index) => {
                    html += `
                        <div class="border rounded p-2 mb-2">
                            <div class="d-flex justify-content-between">
                                <strong>é¡Œç›® ${index + 1}</strong>
                                <span class="badge bg-primary">${item.type}</span>
                            </div>
                            <p class="mt-2">${item.question}</p>
                            <div class="text-success">
                                <strong>æ­£ç¢ºç­”æ¡ˆï¼š</strong>
                                ${item.answers.map(ans => `<span class="badge bg-success me-1">${ans}</span>`).join('')}
                            </div>
                        </div>
                    `;
                });
            }

            html += `<div class="alert alert-info mt-3">å°‡åŒ¯å…¥åˆ°ç« ç¯€ï¼š<strong>${chapter.toUpperCase()}</strong></div>`;
            previewContent.innerHTML = html;
        })
        .catch(error => {
            previewContent.innerHTML = `<div class="alert alert-danger">é è¦½å¤±æ•—ï¼š${error.message}</div>`;
        });
    });

    // è¡¨å–®æäº¤ç¢ºèª
    importForm.addEventListener('submit', function(e) {
        const chapter = chapterSelect.value || customChapterInput.value.trim();
        const isTextMode = methodText.checked;

        if (!chapter) {
            e.preventDefault();
            alert('è«‹é¸æ“‡æˆ–è¼¸å…¥ç« ç¯€');
            return;
        }

        // é©—è­‰ç« ç¯€æ ¼å¼
        if (!/^ch\d{1,2}$/i.test(chapter)) {
            e.preventDefault();
            alert('ç« ç¯€æ ¼å¼ä¸æ­£ç¢ºï¼Œè«‹ä½¿ç”¨ ch1, ch2, ... ç­‰æ ¼å¼');
            return;
        }

        // é©—è­‰å…§å®¹
        if (isTextMode) {
            const text = textContent.value.trim();
            if (!text) {
                e.preventDefault();
                alert('è«‹è²¼å…¥é¡Œç›®å…§å®¹');
                return;
            }
        } else {
            const file = fileInput.files[0];
            if (!file) {
                e.preventDefault();
                alert('è«‹é¸æ“‡æª”æ¡ˆ');
                return;
            }
        }

        const methodText = isTextMode ? 'æ–‡å­—è²¼å…¥' : 'æª”æ¡ˆä¸Šå‚³';
        if (!confirm(`ç¢ºå®šè¦å°‡é¡Œç›® (${methodText}) åŒ¯å…¥åˆ° ${chapter.toUpperCase()} å—ï¼Ÿ`)) {
            e.preventDefault();
        }
    });
});
</script>
{% endblock %}